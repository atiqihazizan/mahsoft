import React, { useState } from 'react'
import { CurrencyFormat, DateFormat } from './index'
import { getDebugData } from '../data/debugData'
import { parseStructuredDescription, renderWhatsAppText } from '../utils/textFormatting.js'

const InvoicePrintPreview = () => {
  const [invoiceData, setInvoiceData] = useState({
    invoiceNumber: 'INV-2024-001',
    date: '2024-01-15',
    dueDate: '2024-02-15',
    customer: {
      name: 'ISMAWADEE Sdn Bhd',
      address: 'No. 123, Jalan Teknologi, 47810 Petaling Jaya, Selangor',
      phone: '+60 3-1234 5678',
      email: 'info@ismawadee.com'
    },
    company: {
      name: 'Mahsoft Sdn Bhd',
      address: 'No. 456, Jalan Digital, 50000 Kuala Lumpur',
      phone: '+60 3-8765 4321',
      email: 'info@mahsoft.com'
    },
    items: getDebugData.invoiceItems(),
    subtotal: 25000.00,
    taxRate: 6,
    taxAmount: 1500.00,
    total: 26500.00,
    notes: getDebugData.invoiceNotes()
  })

  // Function to render structured description for print
  const renderStructuredDescription = (text) => {
    return parseStructuredDescription(text)
  }

  const handlePrint = () => {
    window.print()
  }

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Print Controls */}
      <div className="bg-white shadow-sm border-b p-4 print:hidden">
        <div className="max-w-4xl mx-auto flex justify-between items-center">
          <h1 className="text-xl font-bold text-gray-800">Invoice Print Preview</h1>
          <div className="flex space-x-2">
            <button
              onClick={handlePrint}
              className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
            >
              üñ®Ô∏è Print Invoice
            </button>
            <button
              onClick={() => window.history.back()}
              className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors"
            >
              ‚Üê Kembali
            </button>
          </div>
        </div>
      </div>

      {/* Invoice Content - Print Optimized */}
      <div className="max-w-4xl mx-auto p-8 print:p-0 print:max-w-none">
        <div className="bg-white shadow-lg print:shadow-none">
          {/* Header */}
          <div className="bg-blue-600 text-white p-8 print:bg-white print:text-black">
            <div className="flex justify-between items-start">
              <div>
                <h1 className="text-3xl font-bold print:text-black">INVOICE</h1>
                <p className="text-blue-100 mt-2 print:text-gray-600">Invoice Number: {invoiceData.invoiceNumber}</p>
              </div>
              <div className="text-right">
                <p className="text-blue-100 print:text-gray-600">Date: <DateFormat date={invoiceData.date} /></p>
                <p className="text-blue-100 print:text-gray-600">Due Date: <DateFormat date={invoiceData.dueDate} /></p>
              </div>
            </div>
          </div>

          {/* Company & Customer Info */}
          <div className="p-8 border-b print:border-gray-300">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div>
                <h3 className="font-semibold text-gray-700 mb-2">Bill To:</h3>
                <div className="text-gray-600">
                  <p className="font-medium">{invoiceData.customer.name}</p>
                  <p>{invoiceData.customer.address}</p>
                  <p>Tel: {invoiceData.customer.phone}</p>
                  <p>Email: {invoiceData.customer.email}</p>
                </div>
              </div>
              <div>
                <h3 className="font-semibold text-gray-700 mb-2">From:</h3>
                <div className="text-gray-600">
                  <p className="font-medium">{invoiceData.company.name}</p>
                  <p>{invoiceData.company.address}</p>
                  <p>Tel: {invoiceData.company.phone}</p>
                  <p>Email: {invoiceData.company.email}</p>
                </div>
              </div>
            </div>
          </div>

          {/* Items Table */}
          <div className="p-8">
            <h3 className="font-semibold text-gray-700 mb-4">Items & Services</h3>
            <div className="overflow-x-auto">
              <table className="w-full border-collapse">
                <thead>
                  <tr className="border-b border-gray-300">
                    <th className="text-left py-3 px-4 font-semibold text-gray-700">Description</th>
                    <th className="text-center py-3 px-4 font-semibold text-gray-700 w-24">Qty</th>
                    <th className="text-right py-3 px-4 font-semibold text-gray-700 w-32">Unit Price</th>
                    <th className="text-right py-3 px-4 font-semibold text-gray-700 w-32">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  {invoiceData.items.map((item, index) => {
                    const parsedDescription = renderStructuredDescription(item.description)
                    return (
                      <tr key={item.id} className="border-b border-gray-200">
                        <td className="py-4 px-4">
                          <div className="space-y-2">
                            {parsedDescription.map((section, sectionIndex) => (
                              <div key={sectionIndex}>
                                {section.title && (
                                  <p className="font-bold text-gray-800 mb-1">{section.title}</p>
                                )}
                                {section.items.map((itemText, itemIndex) => (
                                  <p key={itemIndex} className="text-gray-700 ml-2 text-sm">
                                    ‚Ä¢ {itemText}
                                  </p>
                                ))}
                              </div>
                            ))}
                          </div>
                        </td>
                        <td className="text-center py-4 px-4">{item.quantity}</td>
                        <td className="text-right py-4 px-4">
                          <CurrencyFormat amount={item.unitPrice} />
                        </td>
                        <td className="text-right py-4 px-4 font-medium">
                          <CurrencyFormat amount={item.amount} />
                        </td>
                      </tr>
                    )
                  })}
                </tbody>
              </table>
            </div>
          </div>

          {/* Totals */}
          <div className="p-8 bg-gray-50 print:bg-white print:border-t print:border-gray-300">
            <div className="max-w-md ml-auto">
              <div className="space-y-2">
                <div className="flex justify-between">
                  <span className="text-gray-600">Subtotal:</span>
                  <span><CurrencyFormat amount={invoiceData.subtotal} /></span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Tax ({invoiceData.taxRate}%):</span>
                  <span><CurrencyFormat amount={invoiceData.taxAmount} /></span>
                </div>
                <div className="flex justify-between text-lg font-bold border-t border-gray-300 pt-2">
                  <span>Total:</span>
                  <span><CurrencyFormat amount={invoiceData.total} /></span>
                </div>
              </div>
            </div>
          </div>

          {/* Notes */}
          <div className="p-8 border-t border-gray-300">
            <h3 className="font-semibold text-gray-700 mb-4">Notes & Terms</h3>
            <div className="text-gray-700">
              {renderWhatsAppText(invoiceData.notes)}
            </div>
          </div>
        </div>
      </div>

      {/* Print Styles */}
      <style jsx>{`
        @media print {
          body {
            margin: 0;
            padding: 0;
            background: white;
          }
          
          .print\\:hidden {
            display: none !important;
          }
          
          .print\\:p-0 {
            padding: 0 !important;
          }
          
          .print\\:max-w-none {
            max-width: none !important;
          }
          
          .print\\:bg-white {
            background: white !important;
          }
          
          .print\\:text-black {
            color: black !important;
          }
          
          .print\\:border-gray-300 {
            border-color: #d1d5db !important;
          }
          
          .print\\:border-t {
            border-top: 1px solid #d1d5db !important;
          }
          
          .print\\:shadow-none {
            box-shadow: none !important;
          }
        }
      `}</style>
    </div>
  )
}

export default InvoicePrintPreview
