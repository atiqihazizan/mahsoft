import React, { useState, useEffect } from 'react'
import { SimplePageLayout } from '../layouts'
import { SimpleTable, StatusBadge, CurrencyFormat, DateFormat } from '../components'
import { getDebugData } from '../data/debugData'
import { formatText } from '../utils/textFormatting'

const Receipt = () => {
  const [receipts, setReceipts] = useState([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [filterStatus, setFilterStatus] = useState('all') // Default kepada all
  const [showHistory, setShowHistory] = useState(false) // Toggle untuk sejarah


  // Load debug data untuk demo
  useEffect(() => {
    setTimeout(() => {
      setReceipts(getDebugData.receipts())
      setLoading(false)
    }, 1000)
  }, [])

  const filteredReceipts = receipts.filter(receipt => {
    const matchesSearch = receipt.receiptNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         receipt.customerName.toLowerCase().includes(searchTerm.toLowerCase())
    
    // Filter berdasarkan status yang dipilih
    if (filterStatus === 'all') {
      return matchesSearch
    } else if (filterStatus === 'active') {
      // Tunjukkan receipt yang aktif (active)
      const isActive = receipt.status === 'active'
      return matchesSearch && isActive
    } else if (filterStatus === 'done') {
      // Tunjukkan receipt yang selesai (cancelled)
      const isDone = receipt.status === 'cancelled'
      return matchesSearch && isDone
    }
    
    return matchesSearch
  })

  const getPaymentMethodIcon = (method) => {
    const icons = {
      'Bank Transfer': 'üè¶',
      'Cash': 'üíµ',
      'Cheque': 'üìù',
      'Credit Card': 'üí≥'
    }
    return icons[method] || 'üí∞'
  }

  // Debug logging removed for production

  // Table columns configuration
  const columns = [
    {
      key: 'receiptNumber',
      header: 'Receipt No.',
      render: (value) => <span className="font-medium text-gray-900">{value}</span>
    },
    {
      key: 'customerName',
      header: 'Customer',
      render: (value) => (
        <span 
          className="text-sm text-gray-900" 
          title={value} // Show full name on hover
        >
          {/* {formatText(value, 20)} */}
          {value}
        </span>
      )
    },
    {
      key: 'amount',
      header: 'Amount',
      render: (value) => <CurrencyFormat amount={value} />
    },
    {
      key: 'paymentMethod',
      header: 'Method',
      render: (value) => (
        <div className="flex items-center">
          <span className="mr-2">{getPaymentMethodIcon(value)}</span>
          {value}
        </div>
      )
    },
    {
      key: 'status',
      header: 'Status',
      render: (value) => <StatusBadge status={value} />
    },
    {
      key: 'date',
      header: 'Date',
      render: (value) => <DateFormat date={value} />
    },
  ]

  // Table actions configuration
  const actions = [
    {
      label: 'View',
      className: 'text-blue-600 hover:text-blue-900',
      onClick: (row) => {
        // TODO: Implement view receipt functionality
      }
    },
    {
      label: 'Edit',
      className: 'text-green-600 hover:text-green-900',
      onClick: (row) => window.location.href = `/receipts/${row.id}/edit`
    },
    {
      label: 'Print',
      className: 'text-purple-600 hover:text-purple-900',
      onClick: (row) => {
        // TODO: Implement print receipt functionality
      }
    },
    {
      label: 'Delete',
      className: 'text-red-600 hover:text-red-900',
      onClick: (row) => {
        // TODO: Implement delete receipt functionality
      }
    }
  ]

  // Stats configuration
  const stats = [
    {
      label: 'Total Receipts',
      value: receipts.length,
      icon: 'üßæ',
      bgGradient: 'bg-purple-500',
      textColor: 'text-white',
      subtitle: '+15% from last month'
    },
    {
      label: 'Active',
      value: receipts.filter(r => r.status === 'active').length,
      icon: '‚úÖ',
      bgGradient: 'bg-green-500',
      textColor: 'text-white',
      subtitle: 'Active receipts'
    },
    {
      label: 'Cancelled',
      value: receipts.filter(r => r.status === 'cancelled').length,
      icon: '‚ùå',
      bgGradient: 'bg-red-500',
      textColor: 'text-white',
      subtitle: 'Invalid'
    }
  ]

  // Filter options for history mode
  const filterOptions = [
    { value: 'all', label: 'All Status' },
    { value: 'active', label: 'Active' },
    { value: 'cancelled', label: 'Cancelled' }
  ]

  return (
    <SimplePageLayout
      title="RECEIPT MANAGEMENT"
      newButtonText="+ CREATE NEW RECEIPT"
      onNewClick={() => window.location.href = '/receipts/new'}
      buttonColor="purple"
      filterOptions={["ALL", "ACTIVE", "CANCELLED"]}
      activeFilter={filterStatus === 'all' ? 'ALL' : filterStatus === 'active' ? 'ACTIVE' : 'CANCELLED'}
      onFilterChange={(filter) => {
        if (filter === 'ALL') setFilterStatus('all')
        else if (filter === 'ACTIVE') setFilterStatus('active')
        else if (filter === 'CANCELLED') setFilterStatus('cancelled')
      }}
    >
      <SimpleTable
        data={filteredReceipts}
        columns={columns}
        loading={loading}
        onEdit={(row) => {
          const isActive = row.status === 'active'
          isActive ? window.location.href = `/receipts/${row.id}/edit` : alert('Only active receipts can be edited')
        }}
        onDuplicate={(row) => {
          const duplicateData = { ...row }
          delete duplicateData.id
          localStorage.setItem('duplicateReceiptData', JSON.stringify(duplicateData))
          window.location.href = '/receipts/new?duplicate=1'
        }}
        onPreview={(row) => {
          localStorage.setItem('previewReceiptData', JSON.stringify(row))
          window.location.href = '/receipt-print'
        }}
        onDelete={(row) => {
          const isActive = row.status === 'active'
          if (isActive && confirm('Are you sure you want to delete this receipt?')) {
            console.log('Delete receipt:', row.id) // TODO: Implement delete receipt functionality
          } else if (!isActive) {
            alert('Only active receipts can be deleted')
          }
        }}
        hideActionsForStatus={['cancelled']}
      />
    </SimplePageLayout>
  )
}

export default Receipt