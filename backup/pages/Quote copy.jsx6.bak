import React, { useState, useEffect } from 'react'
import { SimplePageLayout, SimpleTable, StatusBadge, CurrencyFormat, DateFormat } from '../components'

const Quote = () => {
  const [quotes, setQuotes] = useState([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [filterStatus, setFilterStatus] = useState('all') // Default kepada all
  const [showHistory, setShowHistory] = useState(false) // Toggle untuk sejarah

  // Function to calculate days until expiry
  const calculateDaysUntilExpiry = (validUntil) => {
    if (!validUntil) return 0
    const today = new Date()
    const validDate = new Date(validUntil)
    const diffTime = validDate - today
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24))
    return diffDays
  }

  // Mock data untuk demo
  useEffect(() => {
    const mockQuotes = [
      {
        id: 1,
        quoteNumber: 'QT-2024-001',
        customerName: 'Syarikat ABC Sdn Bhd',
        amount: 2500.00,
        status: 'accepted',
        date: '2024-01-15',
        validUntil: '2024-02-15'
      },
      {
        id: 2,
        quoteNumber: 'QT-2024-002',
        customerName: 'XYZ Enterprise',
        amount: 1800.50,
        status: 'pending',
        date: '2024-01-16',
        validUntil: '2024-02-16'
      },
      {
        id: 3,
        quoteNumber: 'QT-2024-003',
        customerName: 'Tech Solutions Sdn Bhd',
        amount: 3200.75,
        status: 'expired',
        date: '2024-01-10',
        validUntil: '2024-01-25'
      },
      {
        id: 4,
        quoteNumber: 'QT-2024-004',
        customerName: 'Digital Corp',
        amount: 4500.00,
        status: 'rejected',
        date: '2024-01-20',
        validUntil: '2024-02-20'
      }
    ]
    
    setTimeout(() => {
      setQuotes(mockQuotes)
      setLoading(false)
    }, 1000)
  }, [])

  const filteredQuotes = quotes.filter(quote => {
    const matchesSearch = quote.quoteNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         quote.customerName.toLowerCase().includes(searchTerm.toLowerCase())
    
    // Filter berdasarkan status yang dipilih
    if (filterStatus === 'all') {
      return matchesSearch
    } else if (filterStatus === 'active') {
      // Tunjukkan quote yang aktif (pending, expired)
      const isActive = quote.status === 'pending' || quote.status === 'expired'
      return matchesSearch && isActive
    } else if (filterStatus === 'done') {
      // Tunjukkan quote yang selesai (accepted, rejected)
      const isDone = quote.status === 'accepted' || quote.status === 'rejected'
      return matchesSearch && isDone
    }
    
    return matchesSearch
  })

  // Debug logging (remove in production)
  console.log('Quotes:', quotes)
  console.log('Filtered quotes:', filteredQuotes)
  console.log('Show history:', showHistory)
  console.log('Filter status:', filterStatus)

  // Table columns configuration
  const columns = [
    {
      key: 'quoteNumber',
      header: 'Quote No.',
      render: (value) => <span className="font-medium text-gray-900">{value}</span>
    },
    {
      key: 'customerName',
      header: 'Customer'
    },
    {
      key: 'amount',
      header: 'Amount',
      render: (value) => <CurrencyFormat amount={value} />
    },
    {
      key: 'status',
      header: 'Status',
      render: (value) => <StatusBadge status={value} />
    },
    {
      key: 'date',
      header: 'Date',
      render: (value) => <DateFormat date={value} />
    },
    {
      key: 'validUntil',
      header: 'Validity',
      render: (value, row) => {
        const daysUntilExpiry = calculateDaysUntilExpiry(value)
        if (daysUntilExpiry > 0) {
          return (
            <span className="text-blue-600 font-medium">
              {daysUntilExpiry} days
            </span>
          )
        } else if (daysUntilExpiry === 0) {
          return (
            <span className="text-orange-600 font-medium">
              Last day
            </span>
          )
        } else {
          return (
            <span className="text-red-600 font-medium">
              Expired
            </span>
          )
        }
      }
    }
  ]

  // Table actions configuration
  const actions = [
    {
      label: 'View',
      className: 'text-blue-600 hover:text-blue-900',
      onClick: (row) => console.log('View quote:', row.id)
    },
    {
      label: 'Edit',
      className: 'text-green-600 hover:text-green-900',
      onClick: (row) => window.location.href = `/quotes/${row.id}/edit`
    },
    {
      label: 'Convert to Invoice',
      className: 'text-purple-600 hover:text-purple-900',
      onClick: (row) => console.log('Convert to invoice:', row.id)
    },
    {
      label: 'Delete',
      className: 'text-red-600 hover:text-red-900',
      onClick: (row) => console.log('Delete quote:', row.id)
    }
  ]

  // Stats configuration
  const stats = [
    {
      label: 'Total Quotes',
      value: quotes.length,
      icon: 'üí∞',
      bgGradient: 'bg-green-500',
      textColor: 'text-white',
      subtitle: '+8% from last month'
    },
    {
      label: 'Accepted',
      value: quotes.filter(q => q.status === 'accepted').length,
      icon: '‚úÖ',
      bgGradient: 'bg-blue-500',
      textColor: 'text-white',
      subtitle: 'Accepted by customer'
    },
    {
      label: 'Pending',
      value: quotes.filter(q => q.status === 'pending').length,
      icon: '‚è≥',
      bgGradient: 'bg-yellow-500',
      textColor: 'text-white',
      subtitle: 'Awaiting response'
    },
    {
      label: 'Expired',
      value: quotes.filter(q => q.status === 'expired').length,
      icon: '‚ö†Ô∏è',
      bgGradient: 'bg-red-500',
      textColor: 'text-white',
      subtitle: 'No longer valid'
    }
  ]

  // Filter options for history mode
  const filterOptions = [
    { value: 'all', label: 'All Status' },
    { value: 'accepted', label: 'Accepted' },
    { value: 'pending', label: 'Pending' },
    { value: 'expired', label: 'Expired' },
    { value: 'rejected', label: 'Rejected' }
  ]

  return (
    <SimplePageLayout
      title="QUOTE MANAGEMENT"
      newButtonText="+ CREATE NEW QUOTE"
      onNewClick={() => window.location.href = '/quotes/new'}
      buttonColor="green"
      filterOptions={["ALL", "ACTIVE", "COMPLETED"]}
      activeFilter={filterStatus === 'all' ? 'ALL' : filterStatus === 'active' ? 'ACTIVE' : 'COMPLETED'}
      onFilterChange={(filter) => {
        if (filter === 'ALL') setFilterStatus('all')
        else if (filter === 'ACTIVE') setFilterStatus('active')
        else if (filter === 'COMPLETED') setFilterStatus('done')
      }}
    >
      <SimpleTable
        data={filteredQuotes}
        columns={columns}
        loading={loading}
        onEdit={(row) => console.log('Edit quote:', row)}
        onDuplicate={(row) => console.log('Duplicate quote:', row)}
        onDelete={(row) => console.log('Delete quote:', row)}
      />
    </SimplePageLayout>
  )
}

export default Quote