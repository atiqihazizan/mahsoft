const express = require('express');
const { PrismaClient } = require('@prisma/client');
const { authenticateToken } = require('../utils/auth');
const { success, error } = require('../utils/response');

const router = express.Router();
const prisma = new PrismaClient();

// GET /api/v1/dashboard/stats - Dashboard statistics
router.get('/stats', authenticateToken, async (req, res) => {
  try {
    // Get current year for filtering
    const currentYear = new Date().getFullYear()
    const startOfYear = new Date(currentYear, 0, 1)
    const endOfYear = new Date(currentYear, 11, 31, 23, 59, 59, 999)

    // Get counts for different entities (all time)
    const [
      totalDeliveryOrders,
      totalSuppliers,
      totalQuotes,
      totalInvoices,
      totalReceipts,
      totalPayments,
      totalDebtors,
      activeQuotes,
      pendingInvoices,
      paidInvoices
    ] = await Promise.all([
      prisma.deliveryOrder.count(),
      prisma.supplier.count(),
      prisma.quote.count(),
      prisma.invoice.count(),
      prisma.receipt.count(),
      prisma.payment.count(),
      prisma.debtor.count(),
      prisma.quote.count({ where: { status: 'SENT' } }),
      prisma.invoice.count({ where: { status: 'SENT' } }),
      prisma.invoice.count({ where: { status: 'PAID' } })
    ]);

    // Get counts for current year (ACTIVE documents only)
    const [
      currentYearQuotes,
      currentYearInvoices,
      currentYearReceipts,
      currentYearDeliveryOrders
    ] = await Promise.all([
      prisma.quote.count({ 
        where: { 
          date: { 
            gte: startOfYear, 
            lte: endOfYear 
          },
          status: {
            in: ['DRAFT', 'SENT'] // Active quotes only
          }
        } 
      }),
      prisma.invoice.count({ 
        where: { 
          date: { 
            gte: startOfYear, 
            lte: endOfYear 
          },
          status: {
            in: ['DRAFT', 'SENT', 'OVERDUE'] // Active invoices only
          }
        } 
      }),
      prisma.receipt.count({ 
        where: { 
          date: { 
            gte: startOfYear, 
            lte: endOfYear 
          },
          status: {
            in: ['DRAFT', 'ISSUED', 'UNPAID'] // Active receipts only
          }
        } 
      }),
      prisma.deliveryOrder.count({ 
        where: { 
          date: { 
            gte: startOfYear, 
            lte: endOfYear 
          },
          status: {
            in: ['DRAFT', 'CONFIRMED', 'IN_TRANSIT', 'DELIVERED'] // Active delivery orders only
          }
        } 
      })
    ]);

    // Calculate total amounts
    const totalInvoiceAmount = await prisma.invoice.aggregate({
      _sum: { total: true }
    });

    const totalPaymentAmount = await prisma.payment.aggregate({
      _sum: { amount: true }
    });

    const totalOutstanding = await prisma.debtor.aggregate({
      _sum: { amount: true }
    });

    // Calculate current year amounts
    const currentYearInvoiceAmount = await prisma.invoice.aggregate({
      where: {
        date: {
          gte: startOfYear,
          lte: endOfYear
        }
      },
      _sum: { total: true }
    });

    const currentYearQuoteAmount = await prisma.quote.aggregate({
      where: {
        date: {
          gte: startOfYear,
          lte: endOfYear
        }
      },
      _sum: { total: true }
    });

    const currentYearReceiptAmount = await prisma.receipt.aggregate({
      where: {
        date: {
          gte: startOfYear,
          lte: endOfYear
        }
      },
      _sum: { total: true }
    });

    const stats = {
      counts: {
        deliveryOrders: totalDeliveryOrders,
        suppliers: totalSuppliers,
        quotes: totalQuotes,
        invoices: totalInvoices,
        receipts: totalReceipts,
        payments: totalPayments,
        debtors: totalDebtors,
        activeQuotes,
        pendingInvoices,
        paidInvoices
      },
      currentYear: {
        year: currentYear,
        quotes: currentYearQuotes,
        invoices: currentYearInvoices,
        receipts: currentYearReceipts,
        deliveryOrders: currentYearDeliveryOrders,
        amounts: {
          invoices: currentYearInvoiceAmount._sum.total || 0,
          quotes: currentYearQuoteAmount._sum.total || 0,
          receipts: currentYearReceiptAmount._sum.total || 0
        }
      },
      amounts: {
        totalInvoiceAmount: totalInvoiceAmount._sum.total || 0,
        totalPaymentAmount: totalPaymentAmount._sum.amount || 0,
        totalOutstanding: totalOutstanding._sum.amount || 0
      }
    };

    success(res, stats, 'Dashboard statistics retrieved successfully');

  } catch (err) {
    console.error('Error getting dashboard stats:', err);
    error(res, 'Ralat mendapatkan statistik dashboard');
  }
});

// GET /api/v1/dashboard/recent-activity - Recent activity
router.get('/recent-activity', authenticateToken, async (req, res) => {
  try {
    const recentQuotes = await prisma.quote.findMany({
      take: 5,
      orderBy: { createdAt: 'desc' },
      include: {
        customer: {
          select: { name: true }
        },
        user: {
          select: { name: true }
        }
      }
    });

    const recentInvoices = await prisma.invoice.findMany({
      take: 5,
      orderBy: { createdAt: 'desc' },
      include: {
        customer: {
          select: { name: true }
        },
        user: {
          select: { name: true }
        }
      }
    });

    const recentPayments = await prisma.payment.findMany({
      take: 5,
      orderBy: { createdAt: 'desc' },
      include: {
        customer: {
          select: { name: true }
        }
      }
    });

    const activity = {
      quotes: recentQuotes,
      invoices: recentInvoices,
      payments: recentPayments
    };

    success(res, activity, 'Recent activity retrieved successfully');

  } catch (err) {
    console.error('Error getting recent activity:', err);
    error(res, 'Ralat mendapatkan aktiviti terkini');
  }
});

module.exports = router;
