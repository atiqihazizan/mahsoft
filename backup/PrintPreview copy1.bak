import React, { useEffect, useRef } from 'react'
import { CurrencyFormat, DateFormat } from './index'
import logoImage from '../assets/logo/logo.png'
import { renderStructuredText } from './TextFormatting'

const PrintPreview = ({
  // Document type untuk header (QUOTATION, INVOICE, RECEIPT, etc.)
  documentType = 'DOCUMENT',
  
  // Customer information
  customer = {
    name: '',
    address: '',
    phone: '',
    mobile: '',
    attn: ''
  },
  
  // Document number and dates
  documentNumber = '',
  date = '',
  validUntil = '',
  
  // Items/body content
  items = [],
  
  // Totals
  subtotal = 0,
  tax = 0,
  total = 0,
  
  // Company information
  company = {
    name: '',
    registration: '',
    address: '',
    email: '',
    phone: '',
    manager: ''
  },
  
  // Bank information (optional)
  bank = {
    accountNumber: '',
    bankName: '',
    accountHolder: ''
  },
  
  // Additional fields
  issuedBy = '',
  notes = '',
  
  // Actions
  onPrint,
  onBack,
  onEdit,
  showEditButton = false,
  
  // Loading state
  loading = false,
  error = null
}) => {
  const iframeRef = useRef(null)

  // Dynamic import print.css hanya untuk print preview
  useEffect(() => {
    // Import print.css secara dinamik
    import('../styles/print.css')

    // Cleanup function untuk remove CSS apabila component unmount
    return () => {
      // Remove print.css dari document head jika ada
      const existingLink = document.querySelector('link[href*="print.css"]')
      if (existingLink) {
        existingLink.remove()
      }
    }
  }, [])

  const handlePrint = () => {
    if (iframeRef.current) {
      const iframe = iframeRef.current
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document

      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <link rel="stylesheet" href="/src/index.css">
          <link rel="stylesheet" href="/src/styles/print.css">
          <style>
            @page { margin: 0; padding: 0; }
            body { margin: 0; padding: 0; }
            .print-content { width: 100%; }
          </style>
        </head>
        <body>
          ${document.getElementById('print-content').innerHTML}
        </body>
        </html>
      `

      iframeDoc.open()
      iframeDoc.write(printContent)
      iframeDoc.close()

      iframe.onload = () => {
        iframe.contentWindow.focus()
        iframe.contentWindow.print()
      }
    }
    
    if (onPrint) {
      onPrint()
    }
  }

  const handleBack = () => {
    if (onBack) {
      onBack()
    } else {
      window.history.back()
    }
  }

  const handleEdit = () => {
    if (onEdit) {
      onEdit()
    }
  }

  if (loading) {
    return (
      <div className="max-w-7xl mx-auto p-6">
        <div className="bg-white rounded-lg shadow-lg overflow-hidden">
          <div className="bg-green-600 text-white px-6 py-4">
            <h1 className="text-xl font-semibold">{documentType} Print Preview</h1>
          </div>
          <div className="p-6 text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"></div>
            <p className="mt-4 text-gray-600">Loading document data...</p>
          </div>
        </div>
      </div>
    )
  }

  if (error || !documentNumber) {
    return (
      <div className="max-w-7xl mx-auto p-6">
        <div className="bg-white rounded-lg shadow-lg overflow-hidden">
          <div className="bg-green-600 text-white px-6 py-4">
            <h1 className="text-xl font-semibold">{documentType} Print Preview</h1>
          </div>
          <div className="p-6 text-center">
            <div className="text-red-500 text-6xl mb-4">⚠️</div>
            <h2 className="text-xl font-semibold text-gray-800 mb-2">Document Not Found</h2>
            <p className="text-gray-600 mb-4">{error || 'The requested document could not be found or does not exist.'}</p>
            <button
              onClick={handleBack}
              className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md transition-colors duration-200"
            >
              Go Back
            </button>
          </div>
        </div>
      </div>
    )
  }

  return (
    <>
      {/* Hidden iframe for printing */}
      <iframe
        ref={iframeRef}
        style={{ display: 'none' }}
        title="Print Frame"
      />

      {/* Card Layout */}
      <div className="max-w-7xl mx-auto p-6">
        {/* Card */}
        <div className="bg-white rounded-lg shadow-lg overflow-hidden">
          {/* Card Header */}
          <div className="bg-green-600 text-white px-6 py-4 flex justify-between items-center">
            <h1 className="text-xl font-semibold">{documentType} Print Preview</h1>
            <div className="flex space-x-3">
              {showEditButton && onEdit && (
                <button
                  onClick={handleEdit}
                  className="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md transition-colors duration-200 flex items-center space-x-2"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5h2m-1 14v-4m0 0l5-5m-5 5l-5-5" />
                  </svg>
                  <span>Edit</span>
                </button>
              )}
              <button
                onClick={handleBack}
                className="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-colors duration-200 flex items-center space-x-2"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span>Back</span>
              </button>
              <button
                onClick={handlePrint}
                className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors duration-200 flex items-center space-x-2"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                </svg>
                <span>Print</span>
              </button>
            </div>
          </div>

          {/* Card Body */}
          <div className="p-0">
            {/* Print Content - Modern Layout */}
            <div id="print-content" className="paper A4">
              <div className="sheet padding-15mm">
                {/* Header */}
                <table style={{ width: '100%', marginBottom: '.5rem' }}>
                  <tbody>
                    <tr>
                      <td style={{ textAlign: 'left', width: '12%' }}>
                        <img src={logoImage} alt="Mahsoft Logo" style={{ height: '70px' }} />
                      </td>
                      <td style={{ textAlign: 'left', verticalAlign: 'top', width: '60%' }}>
                        <div>
                          <h1 className="font-audiowide" style={{ fontSize: '1.5rem', margin: '0', padding: '0', color: '#333' }}>
                            {company.name}
                            <span style={{ fontSize: '0.7rem', paddingLeft: '.5rem', color: '#666', fontFamily: 'roboto' }}>
                              {company.registration}
                            </span>
                          </h1>
                        </div>
                        <div className="company-info">
                          <p>{company.address}</p>
                          <p>
                            <span>Email: {company.email}</span>
                            <span>Phone: {company.phone}</span>
                          </p>
                        </div>
                      </td>
                      <td style={{ textAlign: 'right', verticalAlign: 'top' }}>
                        <h1 className="font-audiowide" style={{ fontSize: '1.5rem', margin: '0', color: '#333' }}>{documentType}</h1>
                      </td>
                    </tr>
                  </tbody>
                </table>
                
                <hr />
                <br />

                <div className="clientinfo-container">
                  {/* Client Info */}
                  <div className="clientinfo">
                    <p className="weight-600" style={{ marginBottom: '.3rem' }}>{customer.name}</p>
                    <p>{customer.address}</p>
                    {(customer.phone || customer.mobile) && (
                      <p>
                        {customer.phone && <span>Tel: {customer.phone}</span>}
                        {customer.mobile && <span>Mobile: {customer.mobile}</span>}
                      </p>
                    )}
                    {customer.attn && (
                      <p style={{ fontWeight: '600', marginTop: '.5rem' }}>
                        Attn : {customer.attn}
                      </p>
                    )}
                  </div>

                  <div className="docinfo">
                    <p style={{ fontWeight: '900', margin: '0' }}>
                      <span>No</span>
                      <span>:</span>
                      <span>{documentNumber}</span>
                    </p>
                    <p style={{ margin: '0', color: '#666' }}>
                      <span>Date</span>
                      <span>:</span>
                      <DateFormat date={date} />
                    </p>
                    {validUntil && (
                      <p style={{ margin: '0', color: '#666' }}>
                        <span>Valid</span>
                        <span>:</span>
                        <DateFormat date={validUntil} />
                      </p>
                    )}
                  </div>
                </div>

                <br />

                {/* Items Table */}
                {items && items.length > 0 && (
                  <div className="issuence">
                    <table className="header">
                      <tbody>
                        <tr>
                          <th>Description</th>
                          <th>Qty</th>
                          <th>Unit Price</th>
                          <th>Amount</th>
                        </tr>
                      </tbody>
                    </table>

                    <hr />

                    <table className="rowbody">
                      <tbody>
                        {items.map((item, index) => (
                          <React.Fragment key={item.id || index}>
                            <tr>
                              <td>
                                <div style={{ fontSize: '0.8rem' }}>
                                  {renderStructuredText(item.description || '')}
                                </div>
                              </td>
                              <td>
                                {item.quantity || 0}
                              </td>
                              <td>
                                <CurrencyFormat amount={item.unitPrice || item.price || 0} />
                              </td>
                              <td>
                                <CurrencyFormat amount={item.amount || 0} />
                              </td>
                            </tr>
                          </React.Fragment>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}

                <hr />
                
                {/* Footer */}
                <div className="footer-bottom">
                  <table className="table-signature">
                    <tbody>
                      <tr style={{ display: 'flex' }}>
                        <td style={{ alignSelf: 'left', flex: 1 }}>
                          <div style={{ display: 'flex', flexDirection: 'column', width: '150px', textAlign: 'left' }}>
                            <span>Issued By,</span>
                            <i>{issuedBy || company.manager}</i>
                          </div>
                        </td>
                        <td style={{ alignSelf: 'center' }}>
                          <table className="inv-amt">
                            <tbody>
                              {subtotal > 0 && (
                                <tr>
                                  <td>Subtotal</td>
                                  <td><CurrencyFormat amount={subtotal} /></td>
                                </tr>
                              )}
                              {tax > 0 && (
                                <tr>
                                  <td>Tax</td>
                                  <td><CurrencyFormat amount={tax} /></td>
                                </tr>
                              )}
                              <tr className="font-big">
                                <th style={{ border: '0', textAlign: 'right' }}>Total</th>
                                <th style={{ border: '0', textAlign: 'right' }}><CurrencyFormat amount={total} /></th>
                              </tr>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                {/* Notes */}
                {notes && (
                  <div style={{ marginTop: '1rem', fontSize: '0.8rem' }}>
                    <p><strong>Notes:</strong></p>
                    <p>{renderStructuredText(notes)}</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </>
  )
}

export default PrintPreview
